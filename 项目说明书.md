# 项目说明书

## 应用背景
随着互联网的快速发展和智能设备的大量普及，人们对于基于位置服务的需求日益增长，尤其是在室内的复杂环境中。GPS是目前应用最广泛的定位技术，但是在室内，受到建筑物的影响，信号强度大大衰减、多径效应使得GPS无法在室内实现较为精确的定位。

目前WLAN技术普遍应用在了家庭、旅馆、机场等各类大型及小型建筑物内，相关的研究如雨后春笋，开发了许多能实现较高精度定位的算法，使得WI-FI室内定位成为了定位领域中最引人注目的定位技术之一。

而随着传感器技术的进步和发展，PDR航位推算（Pedestrian Dead Reckoning）的精确性不断提高，使得它也成为了室内定位的可用选项之一。

本项目尝试使用WI-FI位置指纹法、PDR航位推算法进行室内定位，并对位置定位的算法进行改进以获得更好的室内定位效果，主要包括以下几点：
* 利用Android手机采集实际环境中的WIFI接收信号强度数据，并根据设定Reference Point采集到的信号强度值（RSS）生成指纹库；
* 在Android手机上设计并实现了一个基于位置指纹的WI-FI室内定位系统，并在真实的WI-FI环境实现相关算法及其最优的参数选择；
* 分别使用K近邻、基于贝叶斯的概率估计算法完成基于RSS差值的定位并在学校内实测效果；
* 利用Android手机传感器采集加速度信息，利用PDR航位推算算法实现室内定位并实现地图的可视化。

## 基于RSSI的WI-FI室内定位技术
基于WI-FI的室内定位技术可以有多种实现方式，基本上分为：基于无线信号三边的三角定位、位置指纹定位和融合定位。三边信号定位由于其理论模型的不实际性，难以应对现实中的多路径效应及波动，使得实际定位效果难以达到室内定位的要求精度。融合定位算法则难以做到普适使用，不同地方的数据源、不同手机的差异性都会造成结果的巨大差距。本项目采用基于接收信号强度（RSS）的位置指纹法实现的WI-FI室内定位，能够考虑室内复杂环境下信号的时变性而定位成本低，方法实现灵活而精度能够达到预期目标。

信号的RSS或者接受功率取决于接收器的位置，是大多数无线通信设备正常运行中用以感知链路质量、实现切换、适应传输速率等功能的必需参数。RSS不受信号带宽的影响，假设有一个固定的信号发射源，在离它不同距离的位置上的平均RSS的衰减和距离的对数成正比。对于一个可以接收来自多个发射源信号的移动设备，我们可以通过使用来自多个发射源或者接收器的RSS组成的RSS向量，作为和位置相联系的指纹。 注意到RSS本身就是在一段时间内计算或测得的，因此只采集一个RSS样本是不合理的。在WIFI网络中，AP常常要发送一个beacon帧，约100ms发送一次，RSS通常使用这个beacon帧来测量的。它是未加密的，所以即使是一个封闭的网络，也能用来进行定位。

对于特定的位置，都有唯一的可测物理量映射，这种用于标识位置的可测物理量被称为位置指纹。在本系统中，采用WIFI接收信号强度（RSS）来作为位置指纹。一般来说，此定位方法一共分为两个阶段，离线数据采集和在线定位。离线数据采集阶段主要是在预先设定的参考点（RP）上采集多个无线接入点（AP）的接收信号强度样本，并存入位置指纹数据库中。 在线定位阶段，客户端实时采集AP信号强度信息，通过定位算法和指纹数据库中的数据进行匹配，估计用户所在的位置，后文的定位算法都基于此。

### KNN算法的定位
K近邻（KNN）算法通过测量不同特征值之间的距离进行分类，我们这里以参考点获得的指纹向量与RSS向量的欧氏距离定义两个位置的相似度。在指纹库中的M个指纹中，分别计算在信号空间中与RSS观测值的欧氏距离，然后将它所对应的位置坐标作为移动设备的位置。对所有位置计算出的坐标求均值，我们能够得到计算出的所在位置的结果。

K近邻算法的最终效果并不足够好，通过进一步的观察，我们发现实际上和RSS向量欧氏距离越近的点，对最终结果的所占权重也应该越大，于是我们应用了加权K近邻（WKNN）算法对其进行了进一步优化。以欧氏距离的倒数为权重，若恰好RSS向量与指纹向量的欧氏距离为0，则加以更大的权重。考虑过权重之后，最终实现的定位效果要比单纯的KNN算法好得多。

### 基于贝叶斯的概率估计算法的定位及其改进
最早的基于WiFi位置指纹的概率性定位算法是Youssef et al. (2003).提出的，基本的思路是，如果简单地使用一个RSS样本的统计量（比如RSS的均值）可能会带来误差，因为实际的RSS值应该是一个分布。因此，我们可以使用联合概率分布（有多个AP，所以是联合概率分布）来作为指纹。通过采集RSS样本获取联合概率分布并不是一个简单的事情，因为来自各个AP的RSS之间的相互关系不明显。他们假设这是独立的（这种假设是合理的），假设RSS服从高斯分布，然后简单地使用RSS的边缘分布的乘积作为联合分布。由贝叶斯公式，我们可以根据似然来确定后验概率的大小，从而获得相应最可能成为当前位置的点。

但是光使用似然来进行位置的确定，首先我们只能够在已知的RP中选择，而我们的位置很可能并不在确定的点上。于是我们用相同于优化KNN的思路，对各个计算出的贝叶斯概率点进行加权。我们利用最大加权似然估计，并最后求均值得到了相应的计算位置，通过调整参数获得了较好的效果。

### 基于向量余弦相似度算法的定位
余弦相似度衡量的是2个向量间的夹角大小，通过夹角的余弦值表示结果。可以容易的想到，两个向量夹角余弦值越接近于1，两个向量也就越接近。基于此，我们可以利用余弦相似度来衡量RSS向量和指纹向量之间的差距，并最终进行定位。我们对每个RSS向量求余弦相似度，获得一个相同维度的向量。为了使得每个RSS值都能够对最终结果有所贡献，对此向量的每个分量求得均值后，我们得到了最终计算的定位结果。实测表明，效果能够达到预期要求。

## PDR航位推算室内定位技术
航位推算技术最早应用于航海，其基本原理为利用航向传感器和速度传感器获取单位时间内载体的转角和位移，从而对由前一时刻载体的位置和航向推算出当前时刻载体的位置和航向。此算法的定位精度，取决于初始位置和姿态信息的精确性和推算过程中速度和航向信息求解的精度。在本项目中，初始位置设置为手动调试，而航向信息、加速度等可以通过安卓手机的传感器获得。

我们通过加速度传感器峰值的个数进行了步频探测，在计算出相应的步频之后，利用论文中得出的步频和步长之间的特征学习训练模型得到了最终的步长结果。使用 Android 内部实现的 stepcounter 能够较好的实现内部对信号的滤波，并最终确定当前位置。我们利用可视化工具，使其能够精确的描绘出我们的行走路线，实现PDR。
